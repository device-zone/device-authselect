#!/bin/bash

#
# Authselect Autodiscovery - SSSD
# ===============================
#
# This script autogenerates the sssd extension.

set -e
umask 0007


#
# Select the sssd profile
# -----------------------
#
# If the profile is sssd, set that profile.

if [ -L "/etc/device/system/auth/profile" ]; then

  profile=$(basename $(realpath "/etc/device/system/auth/profile"))

  if [ "${profile}" != "sssd" ]; then

    # skip if not sssd
    exit 0

  fi

else

  # skip if nothing
  exit 0

fi


#
# Build sssd options
# ------------------

option=""

if [ -f "/etc/device/system/auth/with-faillock.bin" ]; then
  option+=" with-faillock"
fi
if [ -f "/etc/device/system/auth/with-mkhomedir.bin" ]; then
  option+=" with-mkhomedir"
fi
if [ -f "/etc/device/system/auth/with-smartcard.bin" ]; then
  option+=" with-smartcard"
fi
if [ -f "/etc/device/system/auth/with-smartcard-lock-on-removal.bin" ]; then
  option+=" with-smartcard-lock-on-removal"
fi
if [ -f "/etc/device/system/auth/with-smartcard-required.bin" ]; then
  option+=" with-smartcard-required"
fi
if [ -f "/etc/device/system/auth/with-fingerprint.bin" ]; then
  option+=" with-fingerprint"
fi
if [ -f "/etc/device/system/auth/with-pam-u2f.bin" ]; then
  option+=" with-pam-u2f"
fi
if [ -f "/etc/device/system/auth/with-pam-u2f-2fa.bin" ]; then
  option+=" with-pam-u2f-2fa"
fi
if [ -f "/etc/device/system/auth/without-pam-u2f-nouserok.bin" ]; then
  option+=" without-pam-u2f-nouserok"
fi
if [ -f "/etc/device/system/auth/with-sudo.bin" ]; then
  option+=" with-sudo"
fi

/usr/bin/authselect select sssd ${option} --force

logger -t authselect-autodiscovery "authselect select sssd ${option}"


#
# Make sure ssh reads keys from sss
# ---------------------------------

logger -t "${0}" "Notice: Adding sss_ssh_authorizedkeys to sshd service..."

augtool --load-file=/etc/ssh/sshd_config <<-EOF | /usr/bin/logger -t "{0}"
set /files/etc/ssh/sshd_config/AuthorizedKeysCommand /usr/bin/sss_ssh_authorizedkeys
set /files/etc/ssh/sshd_config/AuthorizedKeysCommandUser root
save
EOF

systemctl try-reload-or-restart sshd


#
# Configure sudoers
# -----------------
#
# Make sure we can become root without a password.

cat > /etc/sudoers.d/device-wheel <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#
%wheel        ALL=(ALL)       NOPASSWD: ALL
EOF


#
# sssd.conf
# ---------

logger -t "${0}" "Notice: Creating sssd sssd.conf..."

cat >> sssd.conf <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#
EOF


if [ -f sssd-domains.conf ]; then
  domains="$(head -n 1 sssd-domains.conf)"
  cat >> sssd.conf <<- EOF
[sssd]
services = nss, pam, ssh, sudo, autofs
domains = ${domains}

[nss]
homedir_substring = /home

[pam]

[sudo]

EOF
else
  cat >> sssd.conf <<- EOF
[sssd]
services = nss, pam, ssh, sudo, autofs
domains = files
EOF
fi

# add files domain
cat > files.conf <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

cat >> files.conf <<- EOF
[domain/files]
id_provider = files
EOF

# special permissions required for sssd to start
install -m 600 -o root -g root "sssd.conf" "/etc/sssd/sssd.conf"

install -m 600 -o root -g root "files.conf" "/etc/sssd/conf.d/files.conf"

