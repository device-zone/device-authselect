#!/bin/bash

#
# Authselect Autodiscovery - SSSD Session Recording
# =================================================
#
# This script autogenerates the sssd session record extension.

set -e
umask 0007


#
# Select the sssd profile
# -----------------------
#
# If the profile is sssd, set that profile.

if [ -L "/etc/device/system/auth/profile" ]; then

  profile=$(basename $(realpath "/etc/device/system/auth/profile"))

  if [ "${profile}" != "sssd" ]; then

    # skip if not sssd
    exit 0

  else

    if test -s "/etc/device/system/auth/sssd/session/notice.txt"; then
      notice=$(cat /etc/device/system/auth/sssd/session/notice.txt)
      notice=$(echo -e "\n${notice}\n" | jq --raw-input --raw-output --ascii-output --slurp .)
    else
      notice="\"\""
    fi

    if test -s "/etc/device/system/auth/sssd/session/scope.txt"; then

      scope="$(head -n 1 /etc/device/system/auth/sssd/session/scope.txt)"

      cat >> session-recording.conf <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

# Note: /etc/device/system/auth/sssd/session/scope.txt
# Modify as follows: device system auth sssd session set scope=${scope}
#
[session_recording]
scope = ${scope}
EOF

      # special permissions required for sssd to start
      install -m 600 -o root -g root "session-recording.conf" "/etc/sssd/conf.d"

      cat >> tlog-rec-session.conf <<- EOF
// Generated by $0 on `date`
// DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
//
{
EOF

      if test -n "${notice}"; then
        cat >> tlog-rec-session.conf <<- EOF
    "notice" : ${notice},
EOF
      fi

      cat >> tlog-rec-session.conf <<- EOF
    "file": {
        // The "file" writer log file path.
        "path" : "/var/log/tlog/session.log"
    },
    "writer" : "file"
}
EOF

      install -m 644 -o root -g root "tlog-rec-session.conf" "/etc/tlog/tlog-rec-session.conf"

      logger -t "${0}" "Notice: Enabled sssd session recording."

    else
      rm -f "/etc/sssd/conf.d/session-recording.conf"
    fi
  fi

else

  # skip if nothing
  rm -f "/etc/sssd/conf.d/session-recording.conf"

fi


    logger -t "${0}" "Notice: Added/updated sssd domain '${domain}'."

